# ─────────────────────────────────────────────────────────────
# InsightDesk CI Pipeline
# Runs unit tests, integration tests, and build verification
# Quality checks (lint, format, typecheck) are enforced locally via Husky pre-push hooks
# ─────────────────────────────────────────────────────────────

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# Cancel in-progress runs when new commits are pushed to same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  NODE_ENV: test

jobs:
  # ─────────────────────────────────────────────────────────────
  # Unit Tests (mocked services, no containers)
  # ─────────────────────────────────────────────────────────────
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    env:
      SKIP_INTEGRATION_TESTS: "true"
      # Minimal env for unit tests (services are mocked)
      DATABASE_URL: postgresql://test:test@localhost:5432/test
      VALKEY_URL: redis://localhost:6379
      BETTER_AUTH_SECRET: test-secret-key-for-testing-minimum-32-chars
      LOG_LEVEL: silent
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run unit tests
        run: bun run test:unit

  # ─────────────────────────────────────────────────────────────
  # Integration Tests (requires real services via docker-compose)
  # ─────────────────────────────────────────────────────────────
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    env:
      RUN_INTEGRATION_TESTS: "true"
      NODE_ENV: test
      PORT: 3099
      HOST: localhost
      API_URL: http://localhost:3099
      FRONTEND_URL: http://localhost:3000
      DATABASE_URL: postgresql://insightdesk:insightdesk_test@localhost:5433/insightdesk_test
      VALKEY_URL: redis://localhost:6380
      BETTER_AUTH_SECRET: test-secret-key-for-testing-minimum-32-chars
      BETTER_AUTH_URL: http://localhost:3099
      SESSION_MAX_AGE: 604800
      SESSION_UPDATE_AGE: 86400
      SMTP_HOST: localhost
      SMTP_PORT: 1026
      EMAIL_FROM: Test <test@example.com>
      STORAGE_PROVIDER: s3
      STORAGE_S3_ENDPOINT: http://localhost:9002
      STORAGE_S3_BUCKET: insightdesk-test
      STORAGE_S3_REGION: us-east-1
      STORAGE_S3_ACCESS_KEY: minioadmin
      STORAGE_S3_SECRET_KEY: minioadmin
      STORAGE_S3_FORCE_PATH_STYLE: "true"
      LOG_LEVEL: silent
      RATE_LIMIT_WINDOW_MS: 60000
      RATE_LIMIT_MAX_REQUESTS: 100

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Start test containers
        run: docker compose -f docker-compose.test.yml up -d

      - name: Setup test database
        run: bun run test:setup --skip-containers

      - name: Run integration tests
        run: bun run test:integration

      - name: Stop test containers
        if: always()
        run: docker compose -f docker-compose.test.yml down -v

  # ─────────────────────────────────────────────────────────────
  # Build Verification (ensures production build works)
  # ─────────────────────────────────────────────────────────────
  build:
    name: Build Verification
    runs-on: ubuntu-latest
    env:
      # Minimal env for build (no runtime needed)
      DATABASE_URL: postgresql://test:test@localhost:5432/test
      VALKEY_URL: redis://localhost:6379
      BETTER_AUTH_SECRET: test-secret-key-for-testing-minimum-32-chars
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build project
        run: bun run build

      - name: Verify build output
        run: |
          if [ -d "dist" ]; then
            echo "✅ Build output exists"
            ls -la dist/
          else
            echo "❌ Build output missing"
            exit 1
          fi
